# æ¨¡å‹è®­ç»ƒæ–¹æ¡ˆé‡æ„æ€»ç»“

## ğŸ¯ é‡æ„ç›®æ ‡

å°†åŸæœ‰çš„ **LSTM æ·±åº¦å­¦ä¹ æ–¹æ¡ˆ** é‡æ„ä¸º **åŸºäºæ ‘æ¨¡å‹çš„é›†æˆå­¦ä¹ æ–¹æ¡ˆ**ï¼Œä¸“é—¨é’ˆå¯¹å°æ ·æœ¬ï¼ˆ600æ¡/çº¿è·¯ï¼‰çš„æ—¶ç©ºç‰¹å¾é¢„æµ‹é—®é¢˜ã€‚

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. ä¾èµ–æ›´æ–° âœ“
**æ–‡ä»¶**: `requirements.txt`

æ·»åŠ äº†æ ‘æ¨¡å‹ç›¸å…³çš„ä¾èµ–ï¼š
- `xgboost>=1.7.0` - XGBoost æ¢¯åº¦æå‡æ ‘
- `lightgbm>=3.3.0` - LightGBM è½»é‡çº§æ¢¯åº¦æå‡
- `category_encoders>=2.5.0` - ç‰¹å¾ç¼–ç 
- `matplotlib, seaborn` - å¯è§†åŒ–

ç§»é™¤äº†æ·±åº¦å­¦ä¹ ç›¸å…³ä¾èµ–ï¼ˆtorchï¼‰ã€‚

---

### 2. æ—¶åºæ•°æ®å¤„ç†æ¨¡å— âœ“
**æ–‡ä»¶**: `src/data/timeseries_dataset.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… **æ—¶åºåˆ‡åˆ†ç­–ç•¥**ï¼ˆå‰å‘éªŒè¯ Walk-Forward Validationï¼‰
  - ä¸¥ç¦éšæœºåˆ‡åˆ†ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
  - å¯¹æ¯æ¡çº¿è·¯ç‹¬ç«‹åˆ‡åˆ†ï¼ˆè®­ç»ƒ:éªŒè¯:æµ‹è¯• = 67:17:16ï¼‰
  
- âœ… **ç‰¹å¾å‡†å¤‡**
  - è‡ªåŠ¨ç¼–ç åˆ†ç±»ç‰¹å¾ï¼ˆroute_id, weather_typeï¼‰
  - One-Hot ç¼–ç å¤©æ°”ç±»å‹
  - å¡«å……ç¼ºå¤±å€¼

- âœ… **ä¾¿æ·å‡½æ•°** `load_timeseries_data()`
  - ä¸€ç«™å¼æ•°æ®åŠ è½½å’Œåˆ‡åˆ†

**å…³é”®ç±»**:
```python
class TimeSeriesDataset:
    - time_series_split()  # æ—¶åºåˆ‡åˆ†
    - prepare_features()    # ç‰¹å¾å‡†å¤‡
    - load_and_split_data() # å®Œæ•´æµç¨‹
```

---

### 3. æ ‘æ¨¡å‹è®­ç»ƒæ¨¡å— âœ“
**æ–‡ä»¶**: `src/models/tree_models.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… **ä¸‰ä¸ªæ¨¡å‹å®ç°**
  - `train_xgboost()` - XGBoost è®­ç»ƒ
  - `train_lightgbm()` - LightGBM è®­ç»ƒ
  - `train_ridge()` - Ridge Regression è®­ç»ƒ

- âœ… **é˜²æ­¢è¿‡æ‹Ÿåˆä¼˜åŒ–**
  ```python
  max_depth: 4              # é™åˆ¶æ ‘æ·±
  learning_rate: 0.05       # å°å­¦ä¹ ç‡
  subsample: 0.8            # è¡Œé‡‡æ ·
  colsample_bytree: 0.8     # åˆ—é‡‡æ ·
  reg_alpha: 1.0            # L1æ­£åˆ™åŒ–
  reg_lambda: 2.0           # L2æ­£åˆ™åŒ–
  ```

- âœ… **ç›®æ ‡å˜é‡å¯¹æ•°å˜æ¢**
  - `transform_target()` - log1p å˜æ¢
  - `inverse_transform_target()` - expm1 é€†å˜æ¢
  - å¤„ç†ååº¦åˆ†å¸ƒï¼Œé™ä½å¼‚å¸¸å€¼å½±å“

- âœ… **ç‰¹å¾é‡è¦æ€§å¯è§†åŒ–**
  - `plot_feature_importance()` - ç»˜åˆ¶ Top N ç‰¹å¾

**å…³é”®ç±»**:
```python
class TreeModelTrainer:
    - train_xgboost()
    - train_lightgbm()
    - train_ridge()
    - train_all_models()     # è®­ç»ƒæ‰€æœ‰æ¨¡å‹
    - evaluate()             # è¯„ä¼°æ¨¡å‹
    - predict()              # é¢„æµ‹
```

---

### 4. æ¨¡å‹é›†æˆæ¨¡å— âœ“
**æ–‡ä»¶**: `src/models/ensemble.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… **åŠ æƒå¹³å‡é›†æˆ**
  - æ”¯æŒè‡ªå®šä¹‰æƒé‡
  - é»˜è®¤å‡ç­‰æƒé‡

- âœ… **æƒé‡ä¼˜åŒ–**
  - åœ¨éªŒè¯é›†ä¸ŠåŸºäº RMSE ä¼˜åŒ–æƒé‡
  - æƒé‡ = 1 / RMSEï¼ˆæ€§èƒ½è¶Šå¥½ï¼Œæƒé‡è¶Šå¤§ï¼‰
  - è‡ªåŠ¨å½’ä¸€åŒ–

- âœ… **æ¨¡å‹ä¿å­˜/åŠ è½½**
  - ä¿å­˜æ‰€æœ‰å­æ¨¡å‹
  - ä¿å­˜é›†æˆæƒé‡
  - æ”¯æŒä¸€é”®åŠ è½½

**å…³é”®ç±»**:
```python
class EnsembleModel:
    - predict()              # é›†æˆé¢„æµ‹
    - optimize_weights()     # ä¼˜åŒ–æƒé‡
    - evaluate()             # è¯„ä¼°é›†æˆæ€§èƒ½
    - save() / load()        # ä¿å­˜/åŠ è½½æ¨¡å‹
```

---

### 5. ä¸»è®­ç»ƒè„šæœ¬é‡æ„ âœ“
**æ–‡ä»¶**: `src/train.py`

**å®Œæ•´è®­ç»ƒæµç¨‹**ï¼š
```
1. åŠ è½½é…ç½® (config.yaml)
2. åŠ è½½å¹¶åˆ‡åˆ†æ•°æ®ï¼ˆæ—¶åºåˆ‡åˆ†ï¼‰
3. åˆå§‹åŒ–è®­ç»ƒå™¨
4. è®­ç»ƒä¸‰ä¸ªæ¨¡å‹ï¼ˆXGBoost + LightGBM + Ridgeï¼‰
5. åˆ›å»ºé›†æˆæ¨¡å‹å¹¶ä¼˜åŒ–æƒé‡
6. åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°
7. ä¿å­˜æ¨¡å‹å’Œç»“æœ
8. ç”Ÿæˆç‰¹å¾é‡è¦æ€§å›¾
```

**è¾“å‡ºæ–‡ä»¶**ï¼ˆ`outputs/` ç›®å½•ï¼‰ï¼š
- `xgboost_model.pkl` - XGBoost æ¨¡å‹
- `lightgbm_model.pkl` - LightGBM æ¨¡å‹
- `ridge_model.pkl` - Ridge æ¨¡å‹
- `ensemble_weights.pkl` - é›†æˆæƒé‡
- `trainer.pkl` - è®­ç»ƒå™¨ï¼ˆå«å˜æ¢å‡½æ•°ï¼‰
- `evaluation_results.pkl` - è¯„ä¼°ç»“æœ
- `feature_names.pkl` - ç‰¹å¾åç§°
- `xgboost_feature_importance.png` - ç‰¹å¾é‡è¦æ€§å›¾
- `lightgbm_feature_importance.png` - ç‰¹å¾é‡è¦æ€§å›¾

---

### 6. é…ç½®æ–‡ä»¶æ›´æ–° âœ“
**æ–‡ä»¶**: `configs/model_config.yaml`

**æ–°å¢é…ç½®é¡¹**ï¼š
```yaml
data:
  data_path: 'f:/Pytorch/Dataset/visitordata.csv'
  route_col: 'route_id'
  date_col: 'date'
  target_col: 'visitor_count'
  train_ratio: 0.67  # å‰å‘éªŒè¯åˆ‡åˆ†
  val_ratio: 0.17
  test_ratio: 0.16

training:
  use_log_transform: true  # å¯¹æ•°å˜æ¢
  xgboost: {...}           # XGBoost å‚æ•°
  lightgbm: {...}          # LightGBM å‚æ•°
  ridge: {...}             # Ridge å‚æ•°

ensemble:
  optimize_weights: true   # æƒé‡ä¼˜åŒ–
  default_weights: {...}   # é»˜è®¤æƒé‡
```

---

### 7. é¢„æµ‹æ¨¡å— âœ“
**æ–‡ä»¶**: `src/predict.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… **åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹**
  - `load_trained_models()` - åŠ è½½é›†æˆæ¨¡å‹

- âœ… **æ‰¹é‡é¢„æµ‹**
  - `predict_single_file()` - å¯¹CSVæ–‡ä»¶é¢„æµ‹
  - è‡ªåŠ¨è®¡ç®—è¯¯å·®ï¼ˆå¦‚æœæœ‰çœŸå®å€¼ï¼‰
  - ä¿å­˜é¢„æµ‹ç»“æœ

- âœ… **çµæ´»é¢„æµ‹**
  - `predict_new_data()` - å¯¹æ–°ç‰¹å¾çŸ©é˜µé¢„æµ‹

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
python src/predict.py \
    --data Dataset/visitordata.csv \
    --output outputs/predictions.csv
```

---

### 8. æ–‡æ¡£ âœ“
**æ–‡ä»¶**: 
- `æ ‘æ¨¡å‹è®­ç»ƒæ–¹æ¡ˆè¯´æ˜.md` - è¯¦ç»†ä½¿ç”¨æ–‡æ¡£
- `é‡æ„æ€»ç»“.md` - æœ¬æ–‡æ¡£

---

## ğŸ”‘ å…³é”®æ”¹è¿›ç‚¹

### å¯¹æ¯” LSTM æ–¹æ¡ˆçš„ä¼˜åŠ¿

| ç»´åº¦ | LSTMæ–¹æ¡ˆï¼ˆåŸï¼‰ | æ ‘æ¨¡å‹é›†æˆæ–¹æ¡ˆï¼ˆæ–°ï¼‰ |
|------|----------------|----------------------|
| **å°æ ·æœ¬é€‚åº”æ€§** | âŒ å®¹æ˜“è¿‡æ‹Ÿåˆ | âœ… æŠ—è¿‡æ‹Ÿåˆèƒ½åŠ›å¼º |
| **ç‰¹å¾å·¥ç¨‹** | âŒ éœ€è¦åºåˆ—åŒ–å¤„ç† | âœ… ç›´æ¥ä½¿ç”¨è¡¨æ ¼ç‰¹å¾ |
| **å¯è§£é‡Šæ€§** | âŒ é»‘ç›’æ¨¡å‹ | âœ… ç‰¹å¾é‡è¦æ€§å¯è§†åŒ– |
| **è®­ç»ƒé€Ÿåº¦** | â±ï¸ è¾ƒæ…¢ï¼ˆGPUåŠ é€Ÿï¼‰ | âœ… å¿«é€Ÿï¼ˆCPUå³å¯ï¼‰ |
| **è¶…å‚è°ƒä¼˜** | ğŸ”§ å¤æ‚ï¼ˆå­¦ä¹ ç‡ã€å±‚æ•°...ï¼‰ | âœ… ç›´è§‚ï¼ˆæ ‘æ·±ã€æ­£åˆ™åŒ–ï¼‰ |
| **æ—¶åºåˆ‡åˆ†** | âš ï¸ å®¹æ˜“æ•°æ®æ³„éœ² | âœ… ä¸¥æ ¼å‰å‘éªŒè¯ |
| **é›†æˆèƒ½åŠ›** | âŒ ä¸æ˜“é›†æˆ | âœ… å†…ç½®é›†æˆç­–ç•¥ |

---

## ğŸ¯ æ ¸å¿ƒç­–ç•¥æ€»ç»“

### 1. ä¸¥æ ¼æ—¶åºåˆ‡åˆ†
- âœ… æŒ‰æ—¥æœŸæ’åº
- âœ… æ¯æ¡çº¿è·¯ç‹¬ç«‹åˆ‡åˆ†
- âœ… å‰å‘éªŒè¯ï¼ˆè®­ç»ƒ â†’ éªŒè¯ â†’ æµ‹è¯•ï¼‰
- âŒ ä¸¥ç¦éšæœºåˆ‡åˆ†

### 2. ç‰¹å¾å·¥ç¨‹
å·²æœ‰ç‰¹å¾ï¼ˆ`visitordata.csv`ï¼‰ï¼š
- âœ… æ»åç‰¹å¾ï¼šlag_1, lag_7, lag_30
- âœ… æ»‘åŠ¨çª—å£ï¼šrolling_mean/median/std (3/7/14å¤©)
- âœ… å¤–éƒ¨ç‰¹å¾ï¼šå¤©æ°”ã€å·¥ä½œæ—¥ã€è®¢å•æ•°

### 3. æ¨¡å‹é˜²è¿‡æ‹Ÿåˆ
- âœ… é™åˆ¶æ ‘æ·±ï¼ˆmax_depth=4ï¼‰
- âœ… L1/L2 æ­£åˆ™åŒ–
- âœ… è¡Œåˆ—é‡‡æ ·ï¼ˆsubsample=0.8ï¼‰
- âœ… æ—©åœï¼ˆearly_stoppingï¼‰
- âœ… å°å­¦ä¹ ç‡ï¼ˆ0.05ï¼‰

### 4. ç›®æ ‡å˜é‡å¤„ç†
- âœ… å¯¹æ•°å˜æ¢ï¼š`log(1+y)`
- âœ… å¤„ç†ååº¦åˆ†å¸ƒ
- âœ… é¢„æµ‹åé€†å˜æ¢ï¼š`exp(y)-1`

### 5. æ¨¡å‹é›†æˆ
- âœ… XGBoostï¼ˆå¼ºå¤§çš„æ¢¯åº¦æå‡ï¼‰
- âœ… LightGBMï¼ˆé«˜æ•ˆå¿«é€Ÿï¼‰
- âœ… Ridgeï¼ˆçº¿æ€§åŸºå‡†ï¼‰
- âœ… åŠ æƒå¹³å‡ï¼ˆæƒé‡ä¼˜åŒ–ï¼‰

---

## ğŸ“Š ä½¿ç”¨æµç¨‹

### å¿«é€Ÿå¼€å§‹
```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. è®­ç»ƒæ¨¡å‹
python src/train.py

# 3. æŸ¥çœ‹ç»“æœ
ls outputs/

# 4. é¢„æµ‹
python src/predict.py
```

### Python API
```python
from src.data.timeseries_dataset import load_timeseries_data
from src.models.tree_models import TreeModelTrainer
from src.models.ensemble import create_ensemble

# åŠ è½½æ•°æ®
(X_train, y_train), (X_val, y_val), (X_test, y_test), features = \
    load_timeseries_data('Dataset/visitordata.csv')

# è®­ç»ƒ
trainer = TreeModelTrainer(use_log_transform=True)
models = trainer.train_all_models(X_train, y_train, X_val, y_val)

# é›†æˆ
ensemble = create_ensemble(models, X_val, y_val, 
                          trainer.inverse_transform_target)

# é¢„æµ‹
y_pred, _ = ensemble.predict(X_test, trainer.inverse_transform_target)
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

âœ… **æ–°å¢**:
- `src/data/timeseries_dataset.py` - æ—¶åºæ•°æ®å¤„ç†
- `src/models/tree_models.py` - æ ‘æ¨¡å‹è®­ç»ƒ
- `src/models/ensemble.py` - æ¨¡å‹é›†æˆ
- `æ ‘æ¨¡å‹è®­ç»ƒæ–¹æ¡ˆè¯´æ˜.md` - ä½¿ç”¨æ–‡æ¡£
- `é‡æ„æ€»ç»“.md` - æœ¬æ–‡æ¡£
- `demo_train.py` - å¿«é€Ÿæ¼”ç¤ºè„šæœ¬

ğŸ”„ **ä¿®æ”¹**:
- `requirements.txt` - æ›´æ–°ä¾èµ–
- `src/train.py` - é‡æ„è®­ç»ƒæµç¨‹
- `configs/model_config.yaml` - æ›´æ–°é…ç½®
- `src/predict.py` - é‡æ„é¢„æµ‹é€»è¾‘

ğŸ—‘ï¸ **å¼ƒç”¨**ï¼ˆä½†ä¿ç•™ï¼‰:
- `src/models/lstm.py` - LSTM æ¨¡å‹ï¼ˆå·²ä¸ä½¿ç”¨ï¼‰
- `src/data/dataset.py` - æ—§æ•°æ®åŠ è½½ï¼ˆå·²ä¸ä½¿ç”¨ï¼‰

---

## ğŸ‰ æ€»ç»“

### é‡æ„æˆæœ
âœ… å®Œæˆä»æ·±åº¦å­¦ä¹ ï¼ˆLSTMï¼‰åˆ°æ ‘æ¨¡å‹é›†æˆçš„å…¨é¢é‡æ„  
âœ… å®ç°ä¸¥æ ¼çš„æ—¶åºéªŒè¯ç­–ç•¥  
âœ… ä¼˜åŒ–å°æ ·æœ¬åœºæ™¯çš„é˜²è¿‡æ‹Ÿåˆèƒ½åŠ›  
âœ… æä¾›å®Œæ•´çš„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹  
âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•  

### é¢„æœŸæ•ˆæœ
- ğŸ“ˆ æé«˜é¢„æµ‹å‡†ç¡®ç‡ï¼ˆRMSE/MAE é™ä½ï¼‰
- ğŸ¯ å¢å¼ºæ³›åŒ–èƒ½åŠ›ï¼ˆæµ‹è¯•é›†æ€§èƒ½ç¨³å®šï¼‰
- ğŸ” æä¾›å¯è§£é‡Šæ€§ï¼ˆç‰¹å¾é‡è¦æ€§ï¼‰
- âš¡ åŠ å¿«è®­ç»ƒé€Ÿåº¦ï¼ˆæ— éœ€GPUï¼‰
- ğŸ›¡ï¸ é¿å…æ•°æ®æ³„éœ²ï¼ˆä¸¥æ ¼æ—¶åºåˆ‡åˆ†ï¼‰

---

**é‡æ„å®Œæˆï¼ç°åœ¨å¯ä»¥è¿è¡Œè®­ç»ƒäº†ï¼** ğŸš€

```bash
python src/train.py
```
